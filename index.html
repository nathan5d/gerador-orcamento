<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Gerador de Orçamento</title>
    <meta name="description" content="Uma ferramenta eficiente para criar orçamentos personalizados com facilidade, permitindo
    que você forneça propostas profissionais com detalhes precisos e formatação elegante.">
    <!-- Inclua os arquivos CSS do Semantic UI -->
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
        integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>

    <!-- Adicione a biblioteca Inputmask -->
    <script src="https://cdn.jsdelivr.net/npm/inputmask"></script>


    <script type="module" src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule="" src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons/ionicons.js"></script>
    <link rel="stylesheet" type="text/css" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" />


    <link rel="stylesheet" href="./vendor/bulma/css/bulma.min.css">


    <link rel="stylesheet" href="/assets/css/style.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">

</head>

<body>

    <div class="container is-mobile">

        <div class="section ">
            <h1 class="title has-text-centered">Gerador de Orçamentos</h1>

            <div class="notification">
                Uma ferramenta eficiente para criar orçamentos personalizados com facilidade, permitindo
                que você forneça propostas profissionais com detalhes precisos e formatação elegante.
            </div>

            <form id="pdf-form">
                <h1 class="title pt-5">Dados do orçamento</h1>
                <p class="subtitle">
                    Forneça os dados necessários
                </p>
                <div class="field">
                    <label for="title" class="label">Título:</label>
                    <div class="control">
                        <input type="text" id="title" name="title" class="input" value="ORÇAMENTO" required>
                    </div>
                </div>
                <div class="field">
                    <label for="company" class="label">Empresa:</label>
                    <div class="control">
                        <input type="text" id="company" name="company" class="input" required>
                    </div>
                </div>
                <div class="field">
                    <label for="jobTitle" class="label">Cargo:</label>
                    <div class="control">
                        <input type="text" id="jobTitle" name="jobTitle" class="input" required>
                    </div>
                </div>
                <div class="field">
                    <label for="location" class="label">Localização:</label>
                    <div class="control">
                        <input type="text" id="location" name="location" class="input" required>
                    </div>
                </div>
                <div class="field">
                    <label for="email" class="label">E-mail:</label>
                    <div class="control">
                        <input type="email" id="email" name="email" class="input" required>
                    </div>
                </div>
                <div class="field">
                    <label for="phone" class="label">Telefone:</label>
                    <div class="control">
                        <input type="text" id="phone" name="phone" class="input" required>
                    </div>
                </div>
                <div class="field">
                    <label for="cnpj" class="label">CNPJ:</label>
                    <div class="control">
                        <input type="text" id="cnpj" name="cnpj" class="input" required>
                    </div>
                </div>

                <h1 class="title pt-5">Proposta para</h1>
                <p class="subtitle">
                    Forneça os dados necessários
                </p>
                <div class="field">
                    <label for="proposalFor" class="label">Nome da empresa:</label>
                    <div class="control">
                        <input type="text" id="proposalFor" name="proposalFor" class="input" required>
                    </div>
                </div>
                <div class="field">
                    <label for="proposalCPFCNPJ" class="label">CPF/CNPJ:</label>
                    <div class="control">
                        <input type="text" id="proposalCPFCNPJ" name="proposalCPFCNPJ" class="input" required>
                    </div>
                </div>
                <div class="field">
                    <label for="proposalLocation" class="label">Localização:</label>
                    <div class="control">
                        <input type="text" id="proposalLocation" name="proposalLocation" class="input" required>
                    </div>
                </div>
                <div class="field">
                    <label for="proposalEmail" class="label">E-mail:</label>
                    <div class="control">
                        <input type="email" id="proposalEmail" name="proposalEmail" class="input" required>
                    </div>
                </div>
                <div class="field">
                    <label for="proposalPhone" class="label">Telefone:</label>
                    <div class="control">
                        <input type="text" id="proposalPhone" name="proposalPhone" class="input" required>
                    </div>
                </div>
                <div class="field">
                    <label for="validUntil" class="label">Válido até:</label>
                    <div class="control">
                        <input type="text" id="validUntil" name="validUntil" class="input" required>
                    </div>
                </div>
                <div class="field">
                    <label for="availability" class="label">Disponibilidade:</label>
                    <div class="control">
                        <input type="text" id="availability" name="availability" class="input" required>
                    </div>
                </div>
                <h1 class="title pt-5">Detalhes do orçamento</h1>
                <p class="subtitle">
                    Forneça os dados necessários
                </p>
                <div id="items-container">

                    <div class="field">
                        <label for="item-description" class="label">Descrição</label>
                        <div class="control">
                            <textarea name="item-description" class="textarea" id="item-description" cols="30" rows="2"
                                class="textarea" placeholder="Descrição"></textarea>
                        </div>
                        <p class="help is-success">Descreva o serviço</p>
                    </div>


                    <div class="field">
                        <div class="field-body">
                            <div class="field ">
                                <div class="control">
                                    <label for="item-quantity" class="label">Quantidade</label>
                                    <input type="number" class="input item-quantity" id="item-quantity"
                                        placeholder="Quantidade">
                                </div>

                            </div>
                            <div class="field">
                                <div class="control">
                                    <label for="item-price-unit" class="label">Preço Unitário</label>
                                    <input type="text" class="input item-price-unit" id="item-price-unit"
                                        placeholder="Preço unitário">
                                </div>
                            </div>
                        </div>

                    </div>


                    <div class="field is-grouped">
                        <div class="control">
                            <button type="button" id="add-item" class="button is-info">Adicionar Item</button>
                        </div>
                        <div class="control">
                            <button type="button" id="export-button" class="button is-success">Gerar PDF</button>
                        </div>



                    </div>

                    <!-- Campos para os itens do orçamento serão adicionados dinamicamente -->
                </div>

            </form>



            <div id="items-add" class="content">
            </div>


        </div>
    </div>


    <script>
        // Verifique se há dados no localStorage
        if (localStorage.getItem('title')) {
            // Recupere os dados e preencha os campos do formulário
            document.getElementById('title').value = localStorage.getItem('title');
        }

        if (localStorage.getItem('company')) {
            document.getElementById('company').value = localStorage.getItem('company');
        }

        if (localStorage.getItem('jobTitle')) {
            document.getElementById('jobTitle').value = localStorage.getItem('jobTitle');
        }

        if (localStorage.getItem('location')) {
            document.getElementById('location').value = localStorage.getItem('location');
        }

        if (localStorage.getItem('phone')) {
            document.getElementById('phone').value = localStorage.getItem('phone');
        }

        if (localStorage.getItem('Cnpj')) {
            document.getElementById('cnpj').value = localStorage.getItem('Cnpj');
        }

        if (localStorage.getItem('email')) {
            document.getElementById('email').value = localStorage.getItem('email');
        }


        // Adicione um ouvinte de eventos 'input' para os campos do formulário
        document.getElementById('title').addEventListener('input', function () {
            localStorage.setItem('title', this.value);
        });

        document.getElementById('company').addEventListener('input', function () {
            localStorage.setItem('company', this.value);
        });

        document.getElementById('jobTitle').addEventListener('input', function () {
            localStorage.setItem('jobTitle', this.value);
        });

        document.getElementById('location').addEventListener('input', function () {
            localStorage.setItem('location', this.value);
        });

        document.getElementById('phone').addEventListener('input', function () {
            localStorage.setItem('phone', this.value);
        });

        document.getElementById('cnpj').addEventListener('input', function () {
            localStorage.setItem('Cnpj', this.value);
        });

        document.getElementById('email').addEventListener('input', function () {
            localStorage.setItem('email', this.value);
        });



        // Configure a máscara de input para o campo de preço unitário
        Inputmask('currency', {
            alias: 'numeric',
            radixPoint: ',',
            groupSeparator: '.',
            autoUnmask: true,
        }).mask(document.getElementById('item-price-unit'));





        // Declare uma lista de itens de serviço
        var serviceItems = [];

        document.getElementById('add-item').addEventListener('click', function () {

            // Obtenha os valores dos campos de descrição, quantidade e preço
            var description = document.getElementById('item-description').value;
            var quantity = parseFloat(document.getElementById('item-quantity').value) || 0;
            // Remova qualquer formatação da máscara (vírgulas e pontos) e converta para um valor numérico
            //var priceUnit = parseFloat(document.getElementById('item-price-unit').value) || 0;
            //var priceUnit = parseFloat(Inputmask.unmaskedvalue(document.getElementById('item-price-unit'))) / 100 || 0;
            // Remova vírgulas e pontos da máscara do preço unitário
            var priceUnit = parseFloat(document.getElementById('item-price-unit').value.replace(/[,.]/g, '')) / 100 || 0;

            if (description.length < 3 && !quantity && !priceUnit > 0) {
                alert('Preencha os detalhes do serviço/produto');
                return
            }
            // Crie um objeto para representar um item de serviço
            var serviceItem = {
                description: description,
                quantity: quantity,
                priceUnit: priceUnit
            };

            // Adicione o objeto à lista de itens de serviço
            serviceItems.push(serviceItem);

            // Limpe os campos para adicionar um novo item
            document.getElementById('item-description').value = '';
            document.getElementById('item-quantity').value = '';
            document.getElementById('item-price-unit').value = '';

            // Atualize a exibição da lista de itens no formulário
            updateServiceItemsList();
        });


        function updateServiceItemsList() {
            var itemsContainer = document.getElementById('items-add');
            itemsContainer.innerHTML = ''; // Limpe o conteúdo atual

            // Percorra a lista de itens de serviço e crie uma linha para cada item
            serviceItems.forEach(function (item, index) {
                var listContainer = document.createElement('ul');
                var listItem = document.createElement('li');
                var itemInfo = document.createElement('div');
                itemInfo.innerHTML = `
            <strong>#</strong> ${index + 1}<br>
            <strong>Descrição:</strong> ${item.description}<br>
            <strong>Quantidade:</strong> ${item.quantity}<br>
            <strong>Preço Unitário:</strong> ${item.priceUnit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}<br>
            <strong>Preço Total:</strong> ${(item.quantity * item.priceUnit).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}<br>
        `;

                var removeButton = document.createElement('button');
                removeButton.innerHTML = 'Remover';
                removeButton.className = 'ui button is-danger';
                removeButton.addEventListener('click', function () {
                    // Remova o item da lista quando o botão "Remover" for clicado
                    serviceItems.splice(index, 1);
                    // Atualize a exibição da lista de itens
                    updateServiceItemsList();
                });

                listItem.appendChild(itemInfo);
                listItem.appendChild(removeButton);
                listContainer.appendChild(listItem);
                itemsContainer.appendChild(listContainer);
            });
        }





        document.getElementById('export-button').addEventListener('click', function () {
            // Obtenha os dados do formulário
            var formData = new FormData(document.getElementById('pdf-form'));
            var budgetData = Object.fromEntries(formData);

            if (serviceItems.length === 0) {
                alert('Adicione algum serviço/produto');
                return

            }

            // Adicione os itens da lista de serviço aos dados do orçamento
            budgetData.items = serviceItems.map(function (item) {
                return {
                    description: item.description,
                    quantity: item.quantity,
                    priceUnit: item.priceUnit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
                    priceTotal: (item.quantity * item.priceUnit).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
                };
            });


            /* Salvar dados no localStorage
            localStorage.setItem('company', budgetData.company);
            localStorage.setItem('title', budgetData.title);
            localStorage.setItem('phone', budgetData.phone);
            localStorage.setItem('Cnpj', budgetData.cnpj);
            localStorage.setItem('email', budgetData.email);
            ///*/

            // Obtenha a data atual
            var dataAtual = new Date();

            // Formate a data em uma string legível
            var dia = String(dataAtual.getDate()).padStart(2, '0');
            var mes = String(dataAtual.getMonth() + 1).padStart(2, '0'); // Mês começa do zero, adicione 1
            var ano = dataAtual.getFullYear();

            var hora = String(dataAtual.getHours()).padStart(2, '0');
            var minutos = String(dataAtual.getMinutes()).padStart(2, '0');
            var segundos = String(dataAtual.getSeconds()).padStart(2, '0');

            var dataFormatada = `${dia}/${mes}/${ano}`;
            var dataFormatadaHoras = `${dia}/${mes}/${ano} ${hora}:${minutos}:${segundos}`;

            //console.log(dataFormatada); // Saída: "04/11/2023 14:30:15"

            // Defina um estilo para o PDF
            var styles = {
                cPrimary: {
                    color: "#5b71eb",
                },
                cSecondary: {
                    color: '#7dae4f',
                },
                header: {
                    color: "#5b71eb",
                    fontSize: 28,
                    bold: true,
                    margin: [0, 10, 0, 10]
                },
                subheader: {
                    color: "#5b71eb",
                    fontSize: 16,
                    bold: true,
                    margin: [0, 10, 0, 10],
                },
                item: {
                    margin: [0, 5, 0, 5]
                },
                total: {
                    bold: true,
                    margin: [0, 10, 0, 10]
                }
            };

            // Função para calcular o total com base nos preços totais dos itens
            function calculateTotal(items) {
                var total = 0;
                for (var i = 0; i < items.length; i++) {
                    var priceTotal = parseFloat(items[i].priceTotal.replace('R$', '').replace('.', '').replace(',', '.')) || 0;
                    if (!isNaN(priceTotal)) {
                        total += priceTotal;
                    }
                }
                return total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }


            // Crie um documento PDF
            var docDefinition = {
                content: [
                    /*{
 
                        text: [
                            //budgetData.title + '\n',
                            { text: budgetData.company + '\n', style: "header", fontSize: 32, bold: true, alignment: "center", color: '#333' },
                            { text: 'ELETRICISTA' + '\n', style: 'subheader', fontSize: 12, bold: false, alignment: "center", color: '#333' },
                        ]
                    },
                    {
                        text: "",
                        style: "subheader"
                    },
                    {
 
                        text: [
                            //budgetData.title + '\n',
                            { text: budgetData.title + '\n', style: "header", fontSize: 24, bold: true, alignment: "center" },
                            { text: 'SERVIÇOS ELÉTRICOS', style: 'subheader', fontSize: 12, bold: false, alignment: "center" },
                        ]
                    },
                    {
                        text: "",
                        style: "subheader"
                    },*/
                    {


                        columns: [
                            { text: budgetData.company, style: "header", fontSize: 24, bold: true, alignment: "left", color: '#333' },

                            {

                                text: [
                                    //budgetData.title + '\n',
                                    { text: budgetData.title + '\n', style: "header", fontSize: 32, bold: true, alignment: "right" },
                                    { text: 'SERVIÇOS ELÉTRICOS', style: 'subheader', fontSize: 12, bold: false, alignment: "right" },
                                ]
                            },
                        ],
                    },
                    /* {
                         columns: [
                             { text: 'SERVIÇOS ELÉTRICOS', style: 'subheader', fontSize: 12, bold: false, alignment: "center" },
                         ]
                     },*/
                    {
                        columns: [
                            {
                                text: [
                                    { text: budgetData.location + '\n', bold: true },
                                ]
                            },
                            {
                                text: [
                                    { text: 'Data: ' + dataFormatada, alignment: "right", fontSize: 12 },
                                    // { text: dataFormatada, alignment: "right" }
                                ]
                            }
                        ],
                    },
                    {
                        columns: [
                            {
                                text: [
                                    budgetData.cnpj + '\n',
                                    { text: "Email: ", bold: true }, budgetData.email + '\n',
                                    { text: "Telefone: ", bold: true }, budgetData.phone + '\n',
                                ]
                            },
                        ],
                    },
                    {
                        text: "Orçamento para:",
                        style: "subheader"
                    },
                    {
                        columns: [
                            {
                                text: [
                                    { text: budgetData.proposalFor + '\n', bold: true },
                                    { text: "CPF/CNPJ: ", bold: true }, budgetData.proposalCPFCNPJ + '\n',
                                    { text: "Endereço: ", bold: true }, budgetData.proposalLocation + '\n',
                                    { text: "Email: ", bold: true }, budgetData.proposalEmail + '\n',
                                    { text: "Telefone: ", bold: true }, budgetData.proposalPhone + '\n',
                                    { text: "CPF/CNPJ: ", bold: true }, budgetData.proposalCPFCNPJ
                                ]
                            },
                        ],
                    },
                    {
                        text: "Descrição:",
                        style: "subheader"
                    },
                    {
                        table: {
                            headerRows: 1,
                            widths: ['auto', '*', 80, 80, 80], // Defina larguras das colunas
                            body: [
                                ["#", "Descrição do serviço", "Quantidade", "Preço Unitário", "Preço Total"], // Atualização dos cabeçalhos
                                ...budgetData.items.map((item, index) => [index + 1, item.description, item.quantity, item.priceUnit, item.priceTotal]) // Atualização dos itens
                            ]
                        },
                        layout: "lightHorizontalLines"
                    },
                    {
                        text: "TOTAL: " + calculateTotal(budgetData.items), // Adicione uma linha de total
                        style: "total", alignment: 'right', fontSize: 14
                    }
                ],
                footer: function (currentPage, pageCount) {
                    return {
                        text: [
                            { text: budgetData.company + ' - ' + budgetData.phone + ' - ' + budgetData.email + '\n', fontSize: 9, color: '#888', alignment: 'center', },
                            { text: 'Página ' + currentPage.toString() + ' de ' + pageCount, fontSize: 8, color: '#ccc', alignment: 'center' }

                        ],


                    };
                },
                defaultStyle: {
                    font: 'Roboto', // Use o nome da fonte que você escolheu
                },
                styles: styles
            };

            // Gere o PDF
            pdfMake.createPdf(docDefinition).download("orcamento.pdf");
        });

    </script>
</body>

</html>