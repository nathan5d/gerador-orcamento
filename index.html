<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Gerador de Orçamento</title>
    <meta name="description" content="Uma ferramenta eficiente para criar orçamentos personalizados com facilidade, permitindo
    que você forneça propostas profissionais com detalhes precisos e formatação elegante.">
    <!-- Inclua os arquivos CSS do Semantic UI -->
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
        integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>

    <!-- Adicione a biblioteca Inputmask -->
    <script src="https://cdn.jsdelivr.net/npm/inputmask"></script>


    <script type="module" src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule="" src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons/ionicons.js"></script>
    <link rel="stylesheet" type="text/css" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" />


    <link rel="stylesheet" href="./vendor/bulma/css/bulma.min.css">


    <link rel="stylesheet" href="/assets/css/style.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">

</head>

<body>

    <div class="container is-mobile">

        <div class="section ">
            <h1 class="title has-text-centered">Gerador de Orçamentos</h1>

            <div class="notification">
                Uma ferramenta eficiente para criar orçamentos personalizados com facilidade, permitindo
                que você forneça propostas profissionais com detalhes precisos e formatação elegante.
            </div>

            <form id="pdf-form">
                <h1 class="title pt-5">Dados do Emissor</h1>
                <p class="subtitle">
                    Forneça os dados necessários
                </p>


                <div class="field">
                    <div class="field-body">
                        <div class="field">
                            <label for="validityDate" class="label">Data de Validade</label>
                            <div class="control">
                                <input class="input" type="date" id="validityDate" name="validityDate">
                            </div>
                        </div>
                        <div class="field">
                            <label for="budgetNumber" class="label">Número do Orçamento</label>
                            <div class="control">
                                <input class="input" type="text" id="budgetNumber" name="budgetNumber"
                                    placeholder="Número do Orçamento">
                            </div>
                        </div>
                    </div>
                </div>



                <div class="field">
                    <label for="title" class="label">Tipo:</label>
                    <div class="control">
                        <input type="text" id="title" name="title" class="input" value="ORÇAMENTO" required>
                    </div>
                </div>
                <div class="field">
                    <label for="subtitle" class="label">Descrição:</label>
                    <div class="control">
                        <input type="text" id="subtitle" name="subtitle" class="input" required>
                    </div>
                    <div class="field">
                        <label for="company" class="label">Empresa:</label>
                        <div class="control">
                            <input type="text" id="company" name="company" class="input" required>
                        </div>
                    </div>
                    <div class="field">
                        <label for="jobTitle" class="label">Cargo:</label>
                        <div class="control">
                            <input type="text" id="jobTitle" name="jobTitle" class="input" required>
                        </div>
                    </div>
                    <div class="field">
                        <label for="location" class="label">Localização:</label>
                        <div class="control">
                            <input type="text" id="location" name="location" class="input" required>
                        </div>
                    </div>
                    <div class="field">
                        <label for="email" class="label">E-mail:</label>
                        <div class="control">
                            <input type="email" id="email" name="email" class="input" required>
                        </div>
                    </div>
                    <div class="field">
                        <label for="phone" class="label">Telefone:</label>
                        <div class="control">
                            <input type="text" id="phone" name="phone" class="input" required>
                        </div>
                    </div>
                    <div class="field">
                        <label for="cnpj" class="label">CNPJ:</label>
                        <div class="control">
                            <input type="text" id="cnpj" name="cnpj" class="input" required>
                        </div>
                    </div>

                    <h1 class="title pt-5">Dados do Cliente</h1>
                    <p class="subtitle">
                        Forneça os dados do cliente
                    </p>
                    <div class="field">
                        <label for="proposalFor" class="label">Nome da empresa:</label>
                        <div class="control">
                            <input type="text" id="proposalFor" name="proposalFor" class="input" required>
                        </div>
                    </div>
                    <div class="field">
                        <label for="proposalCPFCNPJ" class="label">CPF/CNPJ:</label>
                        <div class="control">
                            <input type="text" id="proposalCPFCNPJ" name="proposalCPFCNPJ" class="input" required>
                        </div>
                    </div>
                    <div class="field">
                        <label for="proposalLocation" class="label">Localização:</label>
                        <div class="control">
                            <input type="text" id="proposalLocation" name="proposalLocation" class="input" required>
                        </div>
                    </div>
                    <div class="field">
                        <label for="proposalEmail" class="label">E-mail:</label>
                        <div class="control">
                            <input type="email" id="proposalEmail" name="proposalEmail" class="input" required>
                        </div>
                    </div>
                    <div class="field">
                        <label for="proposalPhone" class="label">Telefone:</label>
                        <div class="control">
                            <input type="text" id="proposalPhone" name="proposalPhone" class="input" required>
                        </div>
                    </div>
                    <!--<div class="field">
                    <label for="validUntil" class="label">Válido até:</label>
                    <div class="control">
                        <input type="text" id="validUntil" name="validUntil" class="input" required>
                    </div>
                </div>
                <div class="field">
                    <label for="availability" class="label">Disponibilidade:</label>
                    <div class="control">
                        <input type="text" id="availability" name="availability" class="input" required>
                    </div>
                </div>
                -->
                    <h1 class="title pt-5">Detalhes do orçamento</h1>
                    <p class="subtitle">
                        Forneça os dados necessários
                    </p>
                    <div id="items-container">

                        <div class="field">
                            <label for="item-description" class="label">Descrição</label>
                            <div class="control">
                                <textarea name="item-description" class="textarea" id="item-description" cols="30"
                                    rows="2" class="textarea" placeholder="Descrição"></textarea>
                            </div>
                            <p class="help is-success">Descreva o serviço</p>
                        </div>


                        <div class="field">
                            <div class="field-body">
                                <div class="field ">
                                    <div class="control">
                                        <label for="item-quantity" class="label">Quantidade</label>
                                        <input type="number" class="input item-quantity" id="item-quantity"
                                            placeholder="Quantidade">
                                    </div>

                                </div>
                                <div class="field">
                                    <div class="control">
                                        <label for="item-price-unit" class="label">Preço Unitário</label>
                                        <input type="text" class="input item-price-unit" id="item-price-unit"
                                            placeholder="Preço unitário">
                                    </div>
                                </div>

                            </div>

                        </div>

                        <div class="field">
                            <div class="control">
                                <label for="discount" class="label">Desconto</label>
                                <input type="text" class="input discount" id="discount" placeholder="Desconto" value="0"
                                    step="0.01">
                            </div>
                        </div>
                        <div class="field">
                            <div class="control">
                                <label for="observations" class="label">Observações</label>
                                <textarea class="textarea name=" id="observations" cols="30" rows="2"></textarea>
                            </div>
                        </div>





                        <div class="field is-grouped">
                            <div class="control">
                                <button type="button" id="add-item" class="button is-info">Adicionar Item</button>
                            </div>
                            <div class="control">
                                <button type="button" id="export-button" class="button is-success">Gerar PDF</button>
                            </div>



                        </div>

                        <!-- Campos para os itens do orçamento serão adicionados dinamicamente -->
                    </div>

            </form>



            <div id="items-add" class="content">
            </div>

            <p>Subtotal: <span id="subtotal">R$ 0,00</span></p>
            <p>Total: <span id="total">R$ 0,00</span></p>

        </div>
    </div>


    <script>
        function generateBudgetNumber() {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear().toString().slice(-2); // Dois dígitos do ano
            const currentMonth = (currentDate.getMonth() + 1).toString().padStart(2, '0'); // Dois dígitos do mês

            // Verifique se já existe um número de orçamento no localStorage
            let currentNumber = localStorage.getItem('budgetNumber');

            // Se não houver um número de orçamento anterior, comece com 1
            if (!currentNumber) {
                currentNumber = 1;
            } else {
                // Caso contrário, incremente o número existente
                currentNumber = parseInt(currentNumber) + 1;
            }

            // Formate o número do orçamento com ano, mês e um número com preenchimento de zeros à esquerda
            const budgetNumber = `${currentYear}${currentMonth}${currentNumber.toString().padStart(3, '0')}`;

            // Salve o novo número no localStorage
            localStorage.setItem('budgetNumber', currentNumber);

            return budgetNumber;
        }

        function capitalizeWords(str) {
            return str.replace(/\b\w/g, (match) => match.toUpperCase());
        }





        const budgetNumberInput = document.getElementById('budgetNumber');
        budgetNumberInput.value = generateBudgetNumber();








        // Check if there is data in localStorage
        const fieldsToSave = ['title', 'subtitle', 'company', 'jobTitle', 'location', 'phone', 'cnpj', 'email'];
        fieldsToSave.forEach(field => {
            const element = document.getElementById(field);
            if (localStorage.getItem(field)) {
                element.value = localStorage.getItem(field) || '';
            }

            element.addEventListener('input', function () {
                localStorage.setItem(field, this.value);
            });
        });

        // Set up input masks for price unit and discount fields
        const inputMaskOptions = {
            alias: 'numeric',
            radixPoint: ',',
            groupSeparator: '.',
            autoUnmask: true,
        };
        ['item-price-unit', 'discount'].forEach(fieldId => {
            Inputmask('currency', inputMaskOptions).mask(document.getElementById(fieldId));
        });

        // Declare a list of service items
        const serviceItems = [];

        document.getElementById('add-item').addEventListener('click', function () {
            const description = document.getElementById('item-description').value;
            const quantity = parseFloat(document.getElementById('item-quantity').value) || 0;
            const priceUnit = parseFloat(document.getElementById('item-price-unit').value.replace(/[,.]/g, '')) / 100 || 0;

            if (description.length < 3 || !quantity || priceUnit <= 0) {
                alert('Please fill in service/product details');
                return;
            }

            const serviceItem = {
                description: description,
                quantity: quantity,
                priceUnit: priceUnit
            };

            serviceItems.push(serviceItem);

            document.getElementById('item-description').value = '';
            document.getElementById('item-quantity').value = '';
            document.getElementById('item-price-unit').value = '';

            updateServiceItemsList();
            //updateTotal(parseFloat(document.getElementById('discount').value.replace(',', '.')));
            updateTotal(parseFloat(document.getElementById('discount').value.replace(',', '.')));
        });

        function updateServiceItemsList() {
            const itemsContainer = document.getElementById('items-add');
            itemsContainer.innerHTML = '';

            serviceItems.forEach(function (item, index) {
                const listContainer = document.createElement('ul');
                const listItem = document.createElement('li');
                const itemInfo = document.createElement('div');
                itemInfo.innerHTML = `
                <strong>#</strong> ${index + 1}<br>
                <strong>Descrição:</strong> ${item.description}<br>
                <strong>Quantidade:</strong> ${item.quantity}<br>
                <strong>Preço Unitário:</strong> ${item.priceUnit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}<br>
                <strong>Preço Total:</strong> ${(item.quantity * item.priceUnit).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}<br>
            `;

                const removeButton = document.createElement('button');
                removeButton.innerHTML = 'Remover';
                removeButton.className = 'ui button is-danger';
                removeButton.addEventListener('click', function () {
                    serviceItems.splice(index, 1);
                    updateServiceItemsList();
                    updateTotal(parseFloat(document.getElementById('discount').value.replace(',', '.')));
                });

                listItem.appendChild(itemInfo);
                listItem.appendChild(removeButton);
                listContainer.appendChild(listItem);
                itemsContainer.appendChild(listContainer);
            });
        }

        function updateTotal(discount) {
            var totalValues = calculateTotal(serviceItems, discount);
            document.getElementById('subtotal').textContent = totalValues.subtotal;
            document.getElementById('total').textContent = totalValues.total;
        }

        function calculateTotal(items, discount, log = '') {


            let subtotal = 0;
            for (let i = 0; i < items.length; i++) {
                subtotal += items[i].quantity * items[i].priceUnit;
            }

            const total = subtotal - discount;


            return {
                subtotal: subtotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
                total: total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
            };
        }

        document.getElementById('export-button').addEventListener('click', function () {
            const formData = new FormData(document.getElementById('pdf-form'));
            const budgetData = Object.fromEntries(formData);

            if (serviceItems.length === 0) {
                alert('Please add some service/product items');
                return;
            }

            var totalValues = {
                discount: 0
            }; // Inicialize o valor de desconto


            const budgetObservations = document.getElementById('observations').value;
          

            function formatToDDMMYYYY(isoDate) {
                const dateParts = isoDate.split('-'); // Suponhamos que a data está no formato ISO 8601 (yyyy-mm-dd)
                const year = dateParts[0];
                const month = dateParts[1];
                const day = dateParts[2];

                return `${day}/${month}/${year}`;
            }


            //const validityDateInput = document.getElementById('validity-date');
            //const isoDate = validityDateInput.value; // O valor da entrada é "yyyy-mm-dd"



            



            //let formatedDate = formatToDDMMYYYY(validityDate);
            // validityDate = 'Validade: '+ validityDate : '';


            //budgetData.observations = document.getElementById('observations').value;
            const budgetDiscount = parseFloat(document.getElementById('discount').value.replace(',', '.')) || 0;
            budgetData.discount = budgetDiscount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            budgetData.number = budgetNumberInput.value || ''



            for (const key in budgetData) {
                if (budgetData.hasOwnProperty(key) && typeof budgetData[key] === 'string') {
                    budgetData[key] = budgetData[key].toUpperCase();
                }
            }

            // Usar um loop for...in para percorrer as propriedades
            for (const key in budgetData) {
                if (budgetData.hasOwnProperty(key)) {
                    // Verificar a propriedade e fazer as modificações necessárias
                    if (key === 'validityDate' && budgetData[key]) {
                        if (budgetData[key]) {
                            const formattedDate = formatToDDMMYYYY(budgetData[key]);

                            budgetData[key] = 'Validade: ' + formattedDate;

                        } else {
                            budgetData[key] = '';
                        }

                    }
                    if (key === 'budgetNumber' && budgetData[key]) {
                        if (budgetData[key]) {
                            budgetData[key] = '#' + budgetData[key];

                        } else {
                            budgetData[key] = '';
                        }
                    }
                }
            }

            budgetData.items = serviceItems.map(item => {
                return {
                    description: item.description,
                    quantity: item.quantity,
                    priceUnit: item.priceUnit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
                    priceTotal: (item.quantity * item.priceUnit).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
                };
            });

            console.log(budgetData);
            const dataAtual = new Date();
            const dia = String(dataAtual.getDate()).padStart(2, '0');
            const mes = String(dataAtual.getMonth() + 1).padStart(2, '0');
            const ano = dataAtual.getFullYear();
            const hora = String(dataAtual.getHours()).padStart(2, '0');
            const minutos = String(dataAtual.getMinutes()).padStart(2, '0');
            const segundos = String(dataAtual.getSeconds()).padStart(2, '0');
            const dataFormatada = `${dia}/${mes}/${ano}`;
            const dataFormatadaHoras = `${dia}/${mes}/${ano} ${hora}:${minutos}:${segundos}`;

            //var totalValues = calculateTotal(serviceItems, budgetData.discount);

            var totalValues = calculateTotal(serviceItems, budgetDiscount, 'export'); // Calcular o total aqui



            var docDefinition = {
                content: [
                    {
                        columns: [
                            {
                                text: [
                                    { text: budgetData.company + '\n', style: ['header', 'darkText'], fontSize: 32, bold: true, alignment: "left" },
                                    { text: budgetData.jobTitle, style: ['subheader', 'darkText'], fontSize: 12, bold: false, alignment: "left" },
                                ]
                            },
                            {
                                text: [
                                    { text: budgetData.title + '\n', style: "header", fontSize: 32, bold: true, alignment: "right" },
                                    { text: budgetData.subtitle, style: 'subheader', fontSize: 12, bold: false, alignment: "right" },
                                ]
                            }
                        ],
                    },
                    {
                        canvas: [
                            {
                                type: 'line',
                                x1: 0,
                                y1: 10,
                                x2: 515,
                                y2: 10,
                                lineWidth: 2,
                                lineColor: '#333'
                            }
                        ],
                    },
                    {
                        text: ' '
                    },
                    {
                        columns: [
                            {
                                text: [
                                    { text: budgetData.location + '\n', bold: true },

                                    { text: "Email: ", bold: true }, budgetData.email + '\n',
                                    { text: "Telefone: ", bold: true }, budgetData.phone + '\n',
                                ]
                            },
                            {
                                text: [
                                    { text: budgetData.budgetNumber + '\n', alignment: "right", fontSize: 12 },
                                    { text: 'Data: ' + dataFormatada + '\n', alignment: "right", fontSize: 12 },

                                    { text: budgetData.validityDate, alignment: "right", fontSize: 12 },
                                ]
                            }
                        ],
                    },
                    {
                        columns: [
                            {
                                text: [
                                    //budgetData.cnpj + '\n',
                                    //{ text: "Email: ", bold: true }, budgetData.email + '\n',
                                    //{ text: "Telefone: ", bold: true }, budgetData.phone + '\n',
                                    { text: budgetData.cnpj + '\n' },
                                ]
                            },
                        ],
                    },
                    {
                        text: "Cliente:",
                        style: "subheader"
                    },
                    {
                        columns: [
                            {
                                text: [
                                    { text: budgetData.proposalFor + '\n', bold: true },
                                    { text: "CPF/CNPJ: ", bold: true }, budgetData.proposalCPFCNPJ + '\n',
                                    { text: "Endereço: ", bold: true }, budgetData.proposalLocation + '\n',
                                    { text: "Email: ", bold: true }, budgetData.proposalEmail + '\n',
                                    { text: "Telefone: ", bold: true }, budgetData.proposalPhone + '\n',
                                    { text: "CPF/CNPJ: ", bold: true }, budgetData.proposalCPFCNPJ
                                ]
                            },
                        ],
                    },
                    {
                        text: "Descrição:",
                        style: "subheader"
                    },
                    {
                        table: {
                            headerRows: 1,
                            widths: ['auto', '*', 80, 80, 80],
                            body: [
                                ["#", "Descrição do serviço", "Quantidade", "Preço Unitário", "Preço Total"],
                                ...budgetData.items.map((item, index) => [index + 1, item.description, item.quantity, item.priceUnit, item.priceTotal])
                            ]
                        },
                        layout: "lightHorizontalLines"
                    },
                    {
                        text: "SUBTOTAL: " + totalValues.subtotal,
                        style: "subtotal",
                        alignment: "right",
                        //fontSize: 14
                    },

                    {
                        text: "DESCONTO: " + budgetData.discount,
                        style: "discount",
                        alignment: "right",
                        //fontSize: 14
                    },
                    {
                        text: "TOTAL: " + totalValues.total,
                        style: "total",
                        alignment: "right",
                        //fontSize: 14
                    },

                    {
                        text: "Observações:",
                        alignment: "center",
                        color: '#444',
                        margin: [0, 10, 0, 5],
                        //fontSize: 14
                    },
                    {
                        text: budgetObservations,
                        alignment: "center",
                        fontSize: 9,
                        color: '#444',
                        margin: [0, 10, 0, 10],
                        //fontSize: 14
                    }
                ],
                footer: function (currentPage, pageCount) {
                    return {
                        text: [
                            { text: budgetData.company + ' - ' + budgetData.phone + ' - ' + budgetData.email + '\n', fontSize: 9, color: '#888', alignment: 'center' },
                            { text: 'Página ' + currentPage.toString() + ' de ' + pageCount, fontSize: 8, color: '#ccc', alignment: 'center' }
                        ],
                    };
                },
                defaultStyle: {
                    font: 'Roboto',
                },
                styles: {
                    header: {
                        color: "#5b71eb",
                        fontSize: 28,
                        bold: true,
                        margin: [0, 10, 0, 10]
                    },

                    subheader: {
                        color: "#5b71eb",
                        fontSize: 16,
                        bold: true,
                        margin: [0, 10, 0, 10],
                    },
                    item: {
                        margin: [0, 5, 0, 5]
                    },
                    subtotal: {
                        fontSize: 12,
                        bold: true,
                        margin: [0, 10, 0, 5]
                    },
                    discount: {
                        fontSize: 12,
                        color: '#7dae4f',
                        bold: true,
                    },
                    total: {
                        fontSize: 14,
                        bold: true,
                        margin: [0, 5, 0, 10]
                    },
                    darkText: {
                        color: "#333",
                    }
                }
            };

            pdfMake.createPdf(docDefinition).download("orcamento.pdf");
        });
    </script>

</body>

</html>